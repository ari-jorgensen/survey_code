<!DOCTYPE html>
<html>
<head>
    <title>Demo Module 1</title>
</head>

<body>

<div id="demo1">
    <h3>Select the chart with the <strong>HIGHER</strong> opacity.</h3>
    <div class="chart-container">
        <h2 class="chart-child" id="chart1">Chart 1</h2>
        <h2 class="chart-child" id="chart2">Chart 2</h2>
    </div>
    <div class="chart-container">
    </div>


    <div class="chart-container">
        <p>Select which chart has the higher opacity.
            <select id="q1" name="q1">
                <option value="1">Chart 1</option>
                <option value="2">Chart 2</option>
            </select>
        </p>
    </div>




</div>


<script>
    (function() {
        var data = {}
            , questions = [1]; // questions to be set by d3

        init();

        function init(){
            console.log(experimentr.data());
            console.log('opacity: ', experimentr.opacity);
            console.log('opacity static: ', experimentr.opacityStatic);

            // Showing opacity for testing purposes only
            // TODO: Use debug flag to turn on/off
            d3.select('#chart1').append('div').text(experimentr.opacityStatic);
            d3.select('#chart2').append('div').text(experimentr.opacity);

            //overrides onNext from experimentr
            d3.select('#next-button')
                .on('click', function(){
                    experimentr.endTimer('demo1');
                    gradeDemo1();
                    experimentr.addData(data);
                    if (checkConvergenceCriteria() == true) {
                        alert('Criteria met, survey finished!');
                        experimentr.end();
                        experimentr.save(experimentr.data);
                    } else {
                        experimentr.question += 1;
                        experimentr.next();
                    }
                });

            experimentr.startTimer('demo1');
            experimentr.release();
            display();
        }


        function display(){
            d3.select('h3')
                .append('div')
                .text('Question ' + experimentr.question);

            d3.select(".chart-container")
                .append("iframe")
                .attr("src", "https://alark.github.io/aesthetics/synthetic2/chart" + experimentr.opacityStatic +".png")
                .attr("class", "chart-child")
                .attr("height", "350px")
                .style("border", "none");
            d3.select(".chart-container")
                .append("iframe")
                .attr("src", "https://alark.github.io/aesthetics/synthetic2/chart" + experimentr.opacity +".png")
                .attr("class", "chart-child")
                .attr("height", "350px")
                .style("border", "none");

            questions.forEach(function(question){
                document.getElementById('q' + question).selectedIndex = -1;
            });

            // This function sets the user's answer after they make a selection
            d3.select('#q1').on('change', function() {
                data["demo1_1"] = this.options[this.selectedIndex].value;
            });

        }

        // Grading function: looks at the opacities of each chart and uses this to
        // determine whether or not user chose correct chart. Could easily be modified
        // to look for chart with lower opacity.
        // TODO: Move this to experimentr.js, make more abstract
        function gradeDemo1() {
            var op1 = experimentr.opacityStatic;
            var op2 = experimentr.opacity;
            var next;
            if ((Math.max(op1, op2) == op1 && Number(data["demo1_1"]) == 1) ||
                (Math.max(op1, op2) == op2 && Number(data["demo1_1"]) == 2)) {
                data[experimentr.question] = 1;
                next = Number(experimentr.opacity + 0.01);
            } else {
                data[experimentr.question] = 0;
                next = Number(experimentr.opacity - 0.03);
            }
            experimentr.opacity = parseFloat(next.toFixed(2));
        }

        function checkConvergenceCriteria() {
            var question = experimentr.question;
            if (question >= 5) {
                var data_tmp = experimentr.data();
                for (var i = 0; i < 5; i++) {
                    console.log(data_tmp[question - i]);
                    if (Number(data_tmp[question - i]) == 0) {
                        return false;
                    }
                }
                return true;
            } else {
                return false;
            }
        }

    }());
</script>
</body>
</html>
